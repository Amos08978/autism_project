{% extends "admin_base.html" %}
{% block content %}
<h2 class="mt-4">測試結果查詢</h2>

<form method="post" class="mb-4">
    <label class="form-label">選擇小朋友</label>
    <select name="child_name" class="form-select" required>
        {% for a in accounts %}
            <option value="{{ a.child_name }}"
                {% if selected_child == a.child_name %}selected{% endif %}>
                {{ a.child_name }}
            </option>
        {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary mt-2">查詢</button>
</form>

{% if grouped_results %}
<!-- ✅ 類型比例統計 -->
    {% if type_stats %}
    <h3 class="mt-4">各類型比例統計</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>類型</th>
                <th>次數</th>
                <th>比例 (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in type_stats %}
            <tr>
                <td>{{ stat.type_name }}</td>
                <td>{{ stat.count }}</td>
                <td>{{ stat.percentage }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    
    {% for group in grouped_results %}
    {% if group.incomplete %}
        <h4 class="mt-3">
        第 {{ group.test_number }} 次測驗（{{ group.type_name }}，未完成）
        </h4>
    {% else %}
        <h4 class="mt-3">
        第 {{ group.test_number }} 次測驗（{{ group.type_name }}）
        </h4>
        <p><strong>正確率：</strong> {{ group.accuracy }} %</p>
    {% endif %}
    <p><strong>批次 ID：</strong> {{ group.batch_id }}</p>
    <p><strong>開始時間：</strong> {{ group.start_time.strftime("%Y-%m-%d %H:%M:%S") }}</p>

    <table class="table table-bordered mt-2">
        <thead>
        <tr>
            <th>時間</th>
            <th>關卡</th>
            <th>小朋友選擇</th>
            <th>系統判斷</th>
        </tr>
        </thead>
        <tbody>
        {% for record in group.records %}
            <tr>
            <td>{{ record.test_datetime }}</td>
            <td>{{ record.stage }}</td>
            <td>{{ record.child_choice }}</td>
            <td>{{ record.system_result }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endfor %}


{% endif %}
{% endblock %}